<!-- templates/index.html -->
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Forex Confluence Dashboard</title>
  <link rel="stylesheet" href="/static/style.css" />
</head>
<body>
  <header>
    <h1>Forex Confluence Dashboard</h1>
    <div class="controls">
      <select id="viewStyle">
        <option value="grid">Grid (Cards)</option>
        <option value="table">Table</option>
      </select>

      <select id="filterBy">
        <option value="all">All</option>
        <option value="strong-bullish">Strong Bullish</option>
        <option value="bullish">Bullish</option>
        <option value="mixed">Mixed</option>
        <option value="bearish">Bearish</option>
        <option value="strong-bearish">Strong Bearish</option>
        <option value="no-confluence">No Confluence</option>
      </select>

      <button id="refreshBtn">Refresh</button>
    </div>
  </header>

  <main id="content" class="grid">
    <!-- cards injected here -->
  </main>

  <footer>
    <small>Data: yfinance (primary) â€” Twelve Data (fallback if configured). UI: custom.</small>
  </footer>

<script>
const API = "/confluence";

function createCard(item) {
  const card = document.createElement('div');
  card.className = 'card';

  // Tag color depends on summary
  const summary = item.Summary || 'No Confluence';

  card.innerHTML = `
    <div class="card-header">
      <div class="pair">${item.Pair}</div>
      <div class="summary ${summary.replace(/\s+/g,'-')}">${summary}</div>
    </div>

    <div class="trend-bars">
      ${Object.entries(item.Confluence).map(([tf, val]) => {
        return `<div class="tf-row">
                  <div class="tf-label">${tf}</div>
                  <div class="tf-value ${val.includes('Strong') ? 'strong' : ''}">${val || '-'}</div>
                </div>`;
      }).join('')}
    </div>

    <div class="confluence-meter">
      <div class="meter-bar">
        <div class="fill" style="width:${item.ConfluencePercent}%"></div>
      </div>
      <div class="meter-label">${item.ConfluencePercent}%</div>
    </div>
  `;
  card.dataset.summary = summary.toLowerCase();
  return card;
}

async function loadData() {
  const res = await fetch(API);
  const data = await res.json();
  render(data);
}

function render(data) {
  const container = document.getElementById('content');
  container.innerHTML = '';
  const view = document.getElementById('viewStyle').value;
  container.className = view === 'grid' ? 'grid' : 'table-view';

  const filter = document.getElementById('filterBy').value;

  // filter logic
  const filtered = data.filter(d => {
    if (filter === 'all') return true;
    const low = d.Summary ? d.Summary.toLowerCase() : 'no confluence';
    if (filter === 'no-confluence') return low === 'no confluence';
    if (filter === 'mixed') return low === 'mixed';
    if (filter === 'strong-bullish') return low === 'strong bullish';
    if (filter === 'strong-bearish') return low === 'strong bearish';
    return low.includes(filter);
  });

  if (view === 'grid') {
    filtered.forEach(item => {
      const card = createCard(item);
      container.appendChild(card);
    });
  } else {
    // render table
    const table = document.createElement('table');
    table.className = 'full-table';
    table.innerHTML = `
      <thead>
        <tr><th>Pair</th><th>Summary</th><th>Weekly</th><th>Daily</th><th>H4</th><th>H1</th><th>Confluence</th></tr>
      </thead>
    `;
    const tbody = document.createElement('tbody');
    filtered.forEach(item => {
      const row = document.createElement('tr');
      row.innerHTML = `
        <td>${item.Pair}</td>
        <td class="${item.Summary.replace(/\s+/g,'-')}">${item.Summary}</td>
        <td>${item.Confluence.Weekly || '-'}</td>
        <td>${item.Confluence.Daily || '-'}</td>
        <td>${item.Confluence.H4 || '-'}</td>
        <td>${item.Confluence.H1 || '-'}</td>
        <td>${item.ConfluencePercent}%</td>
      `;
      tbody.appendChild(row);
    });
    table.appendChild(tbody);
    container.appendChild(table);
  }
}

document.getElementById('refreshBtn').addEventListener('click', loadData);
document.getElementById('viewStyle').addEventListener('change', loadData);
document.getElementById('filterBy').addEventListener('change', loadData);

// auto load
loadData();
</script>
</body>
</html>
